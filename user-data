#cloud-config
autoinstall:
  identity:
    hostname: jammy-server-raid
    password: $6$lKcva4t.TP.1cnZt$B.ZsuZJ2.xr1riFvkzFmIL01B9GsaG2cEC0RRYfAUxLm9xPP14WuU/M552buzQrnSFUwWQdz4PQDlmVk33lBy1
    realname: Ubuntu user
    username: ubuntu
  keyboard:
    layout: us
  locale: en_US.UTF-8
  ssh:
    allow-pw: false
    install-server: true
  apt:
    primary:
      - arches: [default]
        uri: http://ch.archive.ubuntu.com/ubuntu
  storage:
    config:
# Partition table of two disks
    - { ptable: gpt, path: /dev/vda, wipe: superblock-recursive, preserve: false, name: '', grub_device: false, type: disk, id: disk-vda }
    - { ptable: gpt, path: /dev/vdb, wipe: superblock-recursive, preserve: false, name: '', grub_device: false, type: disk, id: disk-vdb }
# Install GRUB on first disk
    - { device: disk-vda, size: 536870912, wipe: superblock, flag: boot, number: 1, preserve: false, grub_device: true, type: partition, id: partition-3 }
    - { fstype: fat32, volume: partition-3, preserve: false, type: format, id: format-2 }
# Install GRUB on second disk
    - { device: disk-vdb, size: 536870912, wipe: superblock, flag: boot, number: 1, preserve: false, grub_device: true, type: partition, id: partition-8 }
    - { fstype: fat32, volume: partition-8, preserve: false, type: format, id: format-5 }
    - { device: disk-vda, size: 1073741824, wipe: superblock, flag: '', number: 2, preserve: false, grub_device: false, type: partition, id: partition-9 }
    - { device: disk-vdb, size: 1073741824, wipe: superblock, flag: '', number: 2, preserve: false, grub_device: false, type: partition, id: partition-10 }
    - { device: disk-vda, size: -1, wipe: superblock, flag: '', number: 3, preserve: false, grub_device: false, type: partition, id: partition-11 }
    - { device: disk-vdb, size: -1, wipe: superblock, flag: '', number: 3, preserve: false, grub_device: false, type: partition, id: partition-12 }
# RAID1 for boot partition and root volume
    - { name: md0, raidlevel: raid1, devices: [ partition-10, partition-9 ], spare_devices: [], preserve: false, wipe: superblock, type: raid, id: raid-0 }
    - { name: md1, raidlevel: raid1, devices: [ partition-11, partition-12 ], spare_devices: [], preserve: false, wipe: superblock, type: raid, id: raid-1 }
# An ext4 boot filesystem on MD
    - { fstype: ext4, volume: raid-0, preserve: false, type: format, id: format-3 }
# LVM on MD
    - { name: vg0, devices: [ raid-1 ], preserve: false, type: lvm_volgroup, id: lvm_volgroup-0 }
    - { name: lv-0, volgroup: lvm_volgroup-0, size: 10737418240B, wipe: superblock, preserve: false, type: lvm_partition, id: lvm_partition-0 }
    - { fstype: ext4, volume: lvm_partition-0, preserve: false, type: format, id: format-4 }
    - { path: /, device: format-4, type: mount, id: mount-4 }
    - { path: /boot, device: format-3, type: mount, id: mount-3 }
# Install GRUB on both disks
    - { path: /boot/efi, device: format-2, type: mount, id: mount-2 }
    - { path: /boot/efi2, device: format-5, type: mount, id: mount-5 }
# Swap
    - { name: swap, volgroup: lvm_volgroup-0, size: 1073741824B, wipe: superblock, preserve: false, type: lvm_partition, id: lvm_partition-1 }
    - { fstype: swap, volume: lvm_partition-1, preserve: false, type: format, id: format-6 }
    - { path: '', device: format-6, type: mount, id: mount-6 }
  late-commands:
  - 'echo "ubuntu ALL=(ALL) NOPASSWD:ALL" > /target/etc/sudoers.d/ubuntu'
  - chmod 440 /target/etc/sudoers.d/ubuntu
  version: 1
